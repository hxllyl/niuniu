<div class="panel panel-default contentBox">

  <div class="panel-heading lineTitle">
    <h3 class="panel-title">发布资源</h3>
  </div>
  <div class="panel-body">
    <%- if @post.new_record? %>
        <%= form_tag(user_my_posts_path, method: :post, multipart: true, class: "form-horizontal sourceForm") do %>
            <%= render 'form_detail' %>
        <% end %>
    <% else %>
        <%= form_tag(user_my_post_path(current_user, @post), method: :put, multipart: true, class: "form-horizontal sourceForm") do %>
            <%= render 'form_detail' %>
        <% end %>
    <% end %></div>


</div>
<script type="text/javascript">

    $(document).ready(function () {
        $(".selectInput").find("input.form-control").attr("disabled", "true");
        $(".methodSelect > .form-group").find(".selectTag").click(function (e) {
            if ($(this).hasClass("disabled")) return false;
            $(".selectInput").find("input.form-control").attr("disabled", "true");
            $(this).next(".selectInput").find("input.form-control").removeAttr("disabled");
            $(".selectInput").removeClass("active");
            $(".methodSelect > .form-group").find(".selectTag").removeClass("active");
            $(this).addClass("active").siblings().removeClass("active");
            $(this).next(".selectInput").addClass("active").focus();
        });

        $(".selectInput").find("input.form-control").bind("focus blur keyup",function(){
            clearNoNum(this);
            $(this).val().toFixed(2);
            //$(this).select();
            //alert($(this).val());
        });
        $(".selectInput").find("input.form-control").bind("focus",function(){
            $(this).select();
        });
        var gPrice = parseFloat($("#guidePrice").html());
        var val1 = parseFloat($("#methodVal1").val());
        var val2 = parseFloat($("#methodVal2").val());
        var val3 = parseFloat($("#methodVal3").val());
        var val4 = parseFloat($("#methodVal4").val());
        if (isNaN(gPrice)) {
            gPrice = 0;
            $("#methodVal4").bind("focus blur keyup", function () {
                $("#methodVal1,#methodVal2,#methodVal3").val("");
            });
        }
        else {
            $("#methodVal1").val((val2 / gPrice * 100).toFixed(2));
            $("#methodVal2").val((gPrice * val1 / 100).toFixed(2));
            $("#methodVal3").val((val4 - gPrice).toFixed(2));
            $("#methodVal4").val((gPrice - val2).toFixed(2));
            $("#methodVal1").keyup(function () {
                if ($(this).val() > 100) {
                    $("#methodVal1").val(100);
                }
                $("#methodVal2").val((gPrice * $(this).val() / 100).toFixed(2));
                $("#methodVal3").val(0);
                $("#methodVal4").val((gPrice - $("#methodVal2").val()).toFixed(2));
            });
            $("#methodVal2").keyup(function () {
                $("#methodVal1").val(($(this).val() / gPrice * 100).toFixed(2));
                $("#methodVal3").val(0);
                $("#methodVal4").val((gPrice - $(this).val()).toFixed(2));
            });
            $("#methodVal3").keyup(function () {
                var thisV = parseFloat($(this).val());
                if (isNaN(thisV)) {
                    thisV = 0;
                }
                $("#methodVal1,#methodVal2").val(0);
                $("#methodVal4").val((gPrice + thisV).toFixed(2));
            });

            $("#methodVal4").bind("focus blur keyup", function () {
                if ($(this).val() < gPrice) {
                    $("#methodVal2").val((gPrice - $(this).val()).toFixed(2));
                    $("#methodVal1").val(($("#methodVal2").val() / gPrice * 100).toFixed(2));
                    $("#methodVal3").val(0);
                }
                else {
                    $("#methodVal1,#methodVal2").val(0);
                    $("#methodVal3").val(($(this).val() - gPrice).toFixed(2));
                }
            });

            $("#methodVal4").blur(function () {
                if ($(this).val() == "") {
                    $(this).val(gPrice);
                }
            });
        }
        $("#methodRadios5").click(function () {
            $(".selectInput").find("input.form-control").val("");
        });

        $('#post_photos').find('input[type="file"]').on('change', function(){
          var n = $(this).attr('class').split(" ")[1];
          if(this.files && this.files[0]){
            var reader = new FileReader();
            reader.onload = function(e){
              $('#'+n).html('<div class="img" id='+n+'><span class="alt"></span><img src="'+e.target.result+'" width="140" height="94"></div>')
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
    });

    function clearNoNum(obj) {
        obj.value = obj.value.replace(/[^\d.]/g, ""); //先把非数字的都替换掉，除了数字和.
        obj.value = obj.value.replace(/^\./g, ""); //必须保证第一个为数字而不是.
        obj.value = obj.value.replace(/\.{2,}/g, "."); //保证只有出现一个.而没有多个.
        obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", "."); //保证.只出现一次，而不能出现两次以上
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/, "$1$2.$3"); //只能输入两个小数
    }
</script>
